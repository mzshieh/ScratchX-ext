<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gravity sensor</title>

    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
        }
        html, body {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #333;
            color: white;
        }
        .mid-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="mid-center">
        <h1 id="bg-info">Connecting to server...</h1>
    </div>

    
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript">
        (function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
        })();
    </script>
    <script>
        var ID = prompt('Please set your name', 'g-sensor') || 'g-sensor';
        var connecting = true;

        var socket = io('http://snp2016.nctu.me:4444');
        var bginfo = document.getElementById('bg-info');

        
        // Init
        socket.on('connect', function() {
            bginfo.innerHTML = ''
            connecting = false;
        });
        socket.on('reconnect', function() {
            bginfo.innerHTML = '';
            connecting = false;
        })
        socket.on('disconnect', function() {
            bginfo.innerHTML = 'Disconnect';
            connecting = true;
        });
        socket.on('reconnect_attempt', function() {
            bginfo.innerHTML = 'Reconnecting to server...';
            connecting = true;
        });
        socket.emit('set name', ID);


        // g-sensor
        var info = {
            vx: 0,
            vy: 0
        };
        window.ondevicemotion = function(event) {
            info.vx = event.accelerationIncludingGravity.x || 0;  
            info.vy = event.accelerationIncludingGravity.y || 0;
            info.vz = event.accelerationIncludingGravity.z || 0;
            info.ax = event.acceleration.x || 0;
            info.ay = event.acceleration.y || 0;
            info.az = event.acceleration.z || 0;
            info.alpha = event.rotationRate.alpha || 0;
            info.beta = event.rotationRate.beta || 0;
            info.gamma = event.rotationRate.gamma || 0;

            info.vx = Math.floor(info.vx*1000) / 1000;
            info.vy = Math.floor(info.vy*1000) / 1000;
            info.vz = Math.floor(info.vz*1000) / 1000;
            info.ax = Math.floor(info.ax*1000) / 1000;
            info.ay = Math.floor(info.ay*1000) / 1000;
            info.az = Math.floor(info.az*1000) / 1000;
        }


        // sender
        var senderClousure = function() {
            var fps = 30;
            var interval = 1000 / fps;
            
            var lastTimestamp = null;
            var requestID = null;
            function sender(timestamp) {
                if( lastTimestamp===null )
                	lastTimestamp = timestamp;

                if( timestamp-lastTimestamp > interval ) {
                    if( !connecting ) {
                    	socket.emit('update', info);
                        bginfo.innerHTML = JSON.stringify(info, null, '\t')
                    }
                    lastTimestamp = timestamp;
                }
                requestID = requestAnimationFrame(sender);
            }
            
            requestID = requestAnimationFrame(sender);
            return function() {
            	return requestID;
            };
        }();
    </script>
</body>
</html>

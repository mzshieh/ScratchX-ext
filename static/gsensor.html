<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gravity sensor</title>

    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
        }
        html, body {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #333;
            color: white;
        }
        .mid-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="mid-center">
        <h1 id="bg-info">Connecting to server...</h1>
    </div>

    
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript">
        (function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
        })();
    </script>
    <script>
        var registered = false;

        var socket = io('http://snp2016.nctu.me:4444');
        var bginfo = document.getElementById('bg-info');

        
        // Init
        socket.on('join room success', function() {
            socket.emit('update', ['type', 'g-sensor']);
            socket.emit('update', ['vx', 0]);
            socket.emit('update', ['vy', 0]);
            registered = true;
        });
        socket.emit('join room', 'g-sensor');


        // g-sensor
        var vx = 0;
        var vy = 0;
        window.ondevicemotion = function(event) {
            vx = event.accelerationIncludingGravity.x || 0;  
            vy = event.accelerationIncludingGravity.y || 0;
        }


        // sender
        var senderClousure = function() {
            var fps = 30;
            var interval = 1000 / fps;
            
            var lastTimestamp = null;
            var requestID = null;
            function sender(timestamp) {
                if( lastTimestamp===null )
                	lastTimestamp = timestamp;

                if( timestamp-lastTimestamp > interval ) {
                    if( registered ) {
                    	socket.emit('update', ['vx', vx]);
                    	socket.emit('update', ['vy', vy]);
                    }
                    lastTimestamp = timestamp;
                }
                bginfo.innerHTML = vx + ' , ' + vy;
                requestID = requestAnimationFrame(sender);
            }
            
            requestID = requestAnimationFrame(sender);
            return function() {
            	return requestID;
            };
        }();
    </script>
</body>
</html>
